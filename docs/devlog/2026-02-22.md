# 2026-02-22

## 02:32 — Hex Data Model Gap Fixes: elevation hexside, feature type arrays, and new HexEntry fields

This session addressed three gaps identified by the BA subagent analysis between the SM rules
data and the current hex data model. All changes are purely additive — no existing fields were
removed or renamed, and all 53 Vitest tests continue to pass without modification.

The first gap was a missing `"elevation"` value in `hexsideTypes`. The SM terrain chart has a
distinct hexside type for "Up/Down Elevation" (thin contour crossing, +1 MP cost) that was
already referenced in `scenario.json` under `hexsideCosts` with the key `"elevation"`, but had
no corresponding string in the `map.json` type registry. Adding it makes the two files
consistent and provides the map editor with the correct palette entry when it later renders
hexside controls.

The second gap was the complete absence of `hexFeatureTypes` and `edgeFeatureTypes` arrays in
`map.json`. The map-editor design spec (`docs/map-editor-design.md`) requires both arrays to be
present as metadata, since the editor needs to populate dropdowns for per-hex features (such as
buildings, fords, and fortifications) and per-edge features (the full set of hexside types plus
`"fence"` and `"bridge"`). The `edgeFeatureTypes` list is a superset of `hexsideTypes`, which
is intentional: `hexsideTypes` remains the legacy registry used by the existing `hexsides`
string-map field, while `edgeFeatureTypes` is the typed palette for the new `edges` object
structure.

The third gap was the schema. `map.schema.js` had no validation for the `slope`,
`wedgeElevations`, `features`, or `edges` fields that the design spec requires on each
`HexEntry`. Two new Zod shapes were introduced — `HexFeature` (`{ type: string }`) and
`EdgeFeature` (`{ type, movementModifier?, losBlocking?, losHeightBonus? }`) — and four optional
fields were added to `HexEntry`. The `hexsides` field was deliberately kept; migrating existing
hex data from the `hexsides` string-map to the new `edges` array structure is deferred to the
next plan, once the map editor UI for saving edge data is built. The `wedgeElevations` tuple is
validated as exactly six numbers (one per hex vertex direction), matching the design spec.

The Prettier formatter reformatted the `wedgeElevations` tuple call — the original multi-line
form was collapsed to a single long line — which was caught by `format:check` and fixed before
commit. A pre-existing formatting issue in `.claude/agents/business-analyst.md` was also
resolved in the same pass.

## 02:43 — PR: Hex data model gap fixes (schema + map.json)

This PR delivers the three data model gaps identified by the BA subagent analysis: the missing
`"elevation"` hexside type, the two new type-registry arrays (`hexFeatureTypes`,
`edgeFeatureTypes`), and the Zod schema additions needed before the map editor can safely
persist the new `edges`, `features`, `slope`, and `wedgeElevations` fields.

The core design decision was to treat all additions as optional fields, leaving the existing
`hexsides` string-map and every current hex entry completely untouched. This means the PR
carries zero migration risk — the 30 existing hex entries validate cleanly against the updated
schema without any data changes. The `hexsides` → `edges` migration is deferred to the plan
that builds the map editor UI for painting edge features.

The `edgeFeatureTypes` array was made a superset of `hexsideTypes` rather than a strict alias.
The two registries serve different purposes: `hexsideTypes` is the legacy palette for the old
string-map field; `edgeFeatureTypes` is the typed palette for the new `EdgeFeature[]` structure.
Having them as separate, independently extensible lists prevents the new system from inheriting
any future quirks of the old one.

The map-editor design doc was also updated in this session to reflect two post-approval
clarifications: the `hexsides` removal decision now correctly says "deprecated (deferred)" rather
than "removed", and `'elevation'` was added to the `EdgeFeature.type` example list in §1. These
were documentation-only corrections with no code impact.

## 05:54 — PR: LOS Test Panel for the map editor

This PR adds an LOS (line-of-sight) verification panel to the map editor dev tool. The motivation is practical: as hexes are digitized by hand (elevation, terrain type, edge features), there is no way to sanity-check whether the entered data produces correct LOS outcomes. The panel lets the digitizer select two hexes, run the algorithm against the current in-memory map data, and read a step-by-step breakdown of why LOS is clear or blocked — without waiting for a game rules engine to exist.

The LOS algorithm lives entirely in `client/src/utils/los.js` as a pure function with no Vue dependency. The key design decisions were: flat-top ODD_Q cube coordinate conversion matching the existing `HexMapOverlay` convention; a 1e-6 nudge on lerp endpoints to break ties at exact hex boundaries (standard practice); equal effective height does not block (strict `>`); and the SM-specific `treeLosHeight` default of 1 is passed as an option so base LoB rules (+3) can be tested by passing `treeLosHeight: 3`. Edge features are looked up on the entering side of each intermediate hex by computing the cube-coordinate delta from the previous hex.

The accordion was refactored from two independent booleans to a single `openPanel` ref with a `togglePanel` function. This is the correct model for a mutually exclusive accordion and removes the possibility of two panels being open simultaneously. The CSS was adjusted so `flex: 1` is applied only to the currently open panel via a conditional `accordion-flex` class, preventing two panels from dividing the available space when one is open. The HLD implementation status block was also corrected: the map editor was moved from "Completed" to "In progress" because terrain digitization and editor feature additions are ongoing.

The `LosTestPanel` keeps `losResult` as internal state and emits a `los-result` event to the parent so `MapEditorView` can drive the `HexMapOverlay` highlighting props (`losHexA`, `losHexB`, `losPathHexes`, `losBlockedHex`) without duplicating the algorithm call. Hex pick mode intercepts `onHexClick` in the parent: if `losSelectingHex` is `'A'` or `'B'`, the click routes to the LOS state rather than the hex editor selection. What is explicitly deferred: the `hexLine` function assumes flat-top orientation and does not handle `orientation: 'pointy'` grid specs; that can be addressed if a pointy-top grid is ever used.

## 05:49 — LOS Test Panel for the map editor

This session added an LOS (line-of-sight) test panel to the map editor dev tool. The goal was to give the digitizer a way to verify that elevation and terrain data entered through the hex editor actually produces correct LOS results — without having to implement full game logic or wait for a rules engine. The feature consists of a pure-function LOS algorithm (`client/src/utils/los.js`), a new accordion panel component (`LosTestPanel.vue`), highlighting changes to `HexMapOverlay.vue`, and coordinating wiring in `MapEditorView.vue`.

The LOS algorithm is a classic cube-coordinate hex line implementation. Game hex IDs (`"CC.RR"`, 1-indexed, row 1 at bottom) are converted to flat-top ODD_Q cube coordinates, a straight line of hexes is interpolated with the cubeRound algorithm (including a standard 1e-6 nudge to avoid ambiguous halfway-point ties), and each intermediate hex is checked against a linearly interpolated sight-line height. Observer and target effective heights include a configurable terrain bonus — defaulting to +1 for wooded terrain per the SM override, rather than the base LoB value of +3. Edge features on a hex's entering side can either block immediately (`losBlocking: true`) or add to the hex's effective height (`losHeightBonus`). The entering direction is derived from the cube-coordinate delta between the previous and current hex in the path.

The accordion was refactored from two independent booleans (`calibrationOpen`, `hexEditOpen`) to a single `openPanel` ref with a `togglePanel` function. This enforces the one-panel-at-a-time constraint cleanly without per-panel flags. The CSS was adjusted so only the open panel receives `flex: 1` (via a conditional `accordion-flex` class), preventing two expanded panels from fighting over the same space. LOS pick mode intercepts `onHexClick` — if a pick is active for hex A or B, the click stores the hex ID and returns focus to the LOS panel instead of selecting the hex for editing.

`HexMapOverlay` received four new optional props: `losHexA` (green stroke), `losHexB` (blue stroke), `losPathHexes` (orange stroke, the intermediate hex path), and `losBlockedHex` (red fill, the first blocking hex). The visibility filter in the computed `gridData` was extended so LOS-related hexes are rendered even outside calibration mode. Color priority follows the plan: calibration purple overrides everything, then blocked-hex red, then LOS A/B/path, then selected-hex gold, then VP red, then default.

`LosTestPanel` keeps `losResult` as internal state and emits a `los-result` event after "Test LOS" is clicked so the parent can update the overlay without duplicating the algorithm call. The `hexLine` and `evaluateLos` functions are also tested directly via 20 unit tests in `los.test.js`, covering round-trip coordinate conversions, path adjacency, terrain blocking, edge feature blocking, uphill CLEAR cases, missing hex data, and the same-hex degenerate case. `LosTestPanel.test.js` adds 16 component-level tests. All 94 tests across the project pass.
